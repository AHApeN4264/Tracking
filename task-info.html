{% extends 'base.html' %}
{% load static %}

{% block title %}
    <title>{{ title }}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'icons/icons8-brutus-32.ico' %}">
    <link rel="stylesheet" href="{% static 'css/room-info.css' %}">
{% endblock %}

{% block body %}
<div class="username-display">
  {% if user.username %}
    <a href="/settings" class="login-link">üë§ {{ user.username }}</a>
    <a href="/wallet" class="login-link">({{ user.wallet }})</a>
  {% else %}
    <a href="/login" class="login-link">üë§ –í–∏ –Ω–µ —É–≤—ñ–π—à–ª–∏ –≤ –∞–∫–∞—É–Ω—Ç</a>
    <a href="/login" class="login-link">–£–≤—ñ–π—Ç–∏</a>
  {% endif %}
  <div class="switch-wrapper">
    <label class="switch" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É">
      <input type="checkbox" id="themeToggle" aria-label="Theme toggle">
      <span class="slider"></span>
    </label>
  </div>
</div>

<div class="background">
  <div class="container">
    <div class="two-columns">
      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
      <div class="left-column">
        {% if messages %}
          {% for message in messages %}
            <p class="{% if 'success' in message.tags %}message{% elif 'error' in message.tags %}error-msg{% else %}info-msg{% endif %}">
              {{ message }}
            </p>
          {% endfor %}
        {% endif %}
        <form method="post" action="{% url 'task-info' task.id %}">
            {% csrf_token %}         
            {% if user_task.status_answer == '–í–∏–∫–æ–Ω–∞–Ω–æ' %}
              <textarea id="tasks-description" name="user_answer"
                required
                placeholder="{{ task.correct_answer }}"
                rows="10"
                class="left-textarea">{% if user_task.answer_text %}{{ user_task.answer_text }}{% endif %}</textarea>    

                <button class="button-disabled" disabled>–í–∂–µ –≤–∏–∫–æ–Ω–∞–Ω–æ</button>
            {% else %}
              <textarea id="tasks-description" name="user_answer"
                required
                placeholder="–í–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è..."
                rows="10"
                class="left-textarea">{% if user_task.answer_text %}{{ user_task.answer_text }}{% endif %}</textarea>   

              {% if task.deadline >= now and user.is_authenticated %}
                <button id="answer" type="submit" class="btn">–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
              {% else %}
              {% if user.is_authenticated %}
                <button class="button-disabled2" disabled>–ù–µ–¥–æ—Å—Ç—É–ø–Ω–µ</button>
              {% else %}
                <button class="button-disabled2" disabled>–ù–µ–º–æ–∂–ª–∏–≤–æ –ø–æ–∫–∏ –≤–∏ –≥–æ—Å—Ç—å</button>
              {% endif %}
              {% endif %}
            {% endif %}
        </form>
      </div>
      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
      <div class="right-column">
        <p class="theme-text"><strong>–†–æ–∑—Ä–æ–±–Ω–∏–∫:</strong> <a href="/user-profile/{{ task.owner.id }}" class="theme-text">{{ task.owner }}</a></p>
        <p class="theme-text"><strong>–û–ø–∏—Å –∑–∞–≤–¥–∞–Ω–Ω—è:</strong><br>{{ task.description }}</p>
        <h3 class="theme-text">–ó–∞–≤–¥–∞–Ω–Ω—è:<br>{{ task.tasks }}</h3>
        <!-- –û—Ü–µ–Ω–∫–∞ -->
        <form method="post" action="{% url 'task_info_grade' task.id %}">
          {% csrf_token %}
          <div class="rating">
            {% for i in "54321" %}
              <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}">
              <label for="star{{ i }}">
                <svg viewBox="0 0 24 24">
                  <polygon points="12,2 15,10 23,10 17,15 19,23 12,18 5,23 7,15 1,10 9,10"></polygon>
                </svg>
              </label>
            {% endfor %}
          </div>
          {% if task.deadline >= now and user.is_authenticated %}
            <button type="submit" class="btn">–û—Ü—ñ–Ω–∏—Ç–∏</button>
          {% else %}
          {% if user.is_authenticated %}
            <button class="button-disabled2" disabled>–ù–µ–¥–æ—Å—Ç—É–ø–Ω–µ</button>
          {% else %}
            <button class="button-disabled2" disabled>–ù–µ–º–æ–∂–ª–∏–≤–æ –ø–æ–∫–∏ –≤–∏ –≥–æ—Å—Ç—å</button>
          {% endif %}
          {% endif %}
        </form>

        <p>–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥: {{ average_rating }} ‚òÖ</p>
        
        {% if comments %}
          {% for comment in comments %}
            <div class="comment-block">
              <span class="comment-header">
                <a href="/user-profile/{{ comment.user.id }}" class="theme-text">{{ comment.user.username }}</a>
                {% if comment.user.subscription != '–ù–µ–º–∞ –ø—ñ–¥–ø–∏—Å–∫–∏' %}
                  {% if comment.user.role == "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á" %}
                    (<span class="user">{{ comment.user.role }}</span>, <span style="color:red;">–ü—ñ–¥–ø–∏—Å–∫–∞</span>)
                  {% elif comment.user.role == "–¢–≤–æ—Ä–µ—Ü—å –ö–æ–Ω—Ç–µ–Ω—Ç—É" %}
                    (<span class="creater-task">{{ comment.user.role }}</span>, <span style="color:red;">–ü—ñ–¥–ø–∏—Å–∫–∞</span>)
                  {% elif comment.user.role == "–¢–≤–æ—Ä–µ—Ü—å –°–∞–π—Ç—É" %}
                    (<span class="creater-site">{{ comment.user.role }}</span>, <span style="color:red;">–ü—ñ–¥–ø–∏—Å–∫–∞</span>)
                  {% endif %}
                {% elif comment.user.subscription != '–ü—ñ–¥–ø–∏—Å–∫–∞' %}
                  {% if comment.user.role == "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á" %}
                    (<span class="user">{{ comment.user.role }}</span>)
                  {% elif comment.user.role == "–¢–≤–æ—Ä–µ—Ü—å –ö–æ–Ω—Ç–µ–Ω—Ç—É" %}
                    (<span class="creater-task">{{ comment.user.role }}</span>)
                  {% elif comment.user.role == "–¢–≤–æ—Ä–µ—Ü—å –°–∞–π—Ç—É" %}
                    (<span class="creater-site">{{ comment.user.role }}</span>)
                  {% endif %}
                {% endif %}
                 ‚Äî {{ comment.created_at|date:"d.m.Y H:i" }}
              </span>       

              <div class="comment-text">{{ comment.text }}</div>        

              {% if user.role == '–¢–≤–æ—Ä–µ—Ü—å –°–∞–π—Ç—É' or user == comment.user %}
                <form method="post" action="{% url 'delete-comment' comment.id %}" class="delete-form" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="delete-btn" style="color:red;"
                          onclick="return confirm('–í–∏ —Ç–æ—á–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä?')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                </form>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <p>–ù–µ–º–∞—î –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤</p>
        {% endif %}


        <h4>–ù–∞–ø–∏—Å–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä:</h4>
        <form method="post" action="{% url 'task_info_comment' task.id %}">
            {% csrf_token %}
            <textarea name="comment" rows="4" required 
                      style="resize: vertical; width: 100%;"
                      placeholder="–í–∞—à –∫–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
          {% if task.deadline >= now and user.is_authenticated %}
            <button type="submit" class="btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
          {% else %}
          {% if user.is_authenticated %}
            <button class="button-disabled2" disabled>–ù–µ–¥–æ—Å—Ç—É–ø–Ω–µ</button>
          {% else %}
            <button class="button-disabled2" disabled>–ù–µ–º–æ–∂–ª–∏–≤–æ –ø–æ–∫–∏ –≤–∏ –≥–æ—Å—Ç—å</button>
          {% endif %}
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>

<style>
textarea {
    color: #000;
    background-color: #fff; 
}

textarea::placeholder {
    color: #000;
    opacity: 1;  
}

html.dark-theme textarea {
    color: #fff; 
    background-color: #333;
}

html.dark-theme textarea::placeholder {
    color: #fff; 
    opacity: 1;
}

/* –∫–æ–º–µ–Ω—Ç–∞—Ä–∏–∏ */
.comment-block {
  background-color: #FFF0F5; 
  border: 1px solid #FF69B4; 
  border-radius: 8px;
  padding: 10px 15px;
  margin-bottom: 10px;
  color: #000000;
}

.comment-header {
  display: inline;     
  margin: 0;
  font-weight: bold;
  color: #000000;
}

.comment-text {
  display: block;      
  margin: 5px 0;
}

.delete-form {
  display: inline;     
}

.delete-btn {
  background: none;
  border: none;
  color: #ff0000;
  cursor: pointer;
  padding: 0;
  font-size: 0.9em;
}

.delete-btn:hover {
  text-decoration: underline;
}

html.dark-theme .delete-btn {
  color: #9f0000; 
}

.user {
  color:rgb(0, 0, 0);
}
html.dark-theme .user{
  color: #b8b8b8;
}

.creater-task {
  color:rgb(0, 0, 255); 
}
html.dark-theme {
  color:rgb(0, 26, 156); 
}

.creater-site {
  color:rgb(208, 0, 255); 
}
html.dark-theme .creater-site{
  color:rgb(122, 0, 150); 
}

/* –î–ª—è —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã */
html.dark-theme .comment-block {
  background-color: #a67777; 
  border: 1px solid #97446e; 
  color: #d0d0d0;
}

html.dark-theme .comment-header {
  color: #b8b8b8;
}

.tasks-description {
  resize: vertical; 
  overflow: auto;   
  min-height: 100px;
  max-height: 500px;
  width: 100%;      
  box-sizing: border-box;
}

.two-columns {
  display: flex;
  gap: 30px;
}

.left-column {
  flex: 2;
  min-width: 400px;
  display: flex;
  flex-direction: column;
  gap: 10px; 
}

.left-textarea,
.left-column .btn {
  width: 100%;
  box-sizing: border-box;
}

.right-column {
  flex: 1.5;
  min-width: 300px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding-left: 100px;
  max-width: 900px;
  min-height: 500px;
}

.container {
  background-color: white;
  padding: 30px 40px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
  max-width: 1500px;      
  width: 100%;
  min-height: 600px;      
  transition: background-color 0.3s ease, color 0.3s ease;
}
/* –†–µ–π—Ç–∏–Ω–≥ */
/* From Uiverse.io by SelfMadeSystem */ 
.rating {
  display: flex;
  flex-direction: row-reverse;
  gap: 0.3rem;
  --stroke: #666;
  --fill: #ffc73a;
}

.rating input {
  appearance: unset;
}

.rating label {
  cursor: pointer;
}

.rating svg {
  width: 2rem;
  height: 2rem;
  overflow: visible;
  fill: transparent;
  stroke: var(--stroke);
  stroke-linejoin: bevel;
  stroke-dasharray: 12;
  animation: idle 4s linear infinite;
  transition: stroke 0.2s, fill 0.5s;
}

@keyframes idle {
  from {
    stroke-dashoffset: 24;
  }
}

.rating label:hover svg {
  stroke: var(--fill);
}

.rating input:checked ~ label svg {
  transition: 0s;
  animation: idle 4s linear infinite, yippee 0.75s backwards;
  fill: var(--fill);
  stroke: var(--fill);
  stroke-opacity: 0;
  stroke-dasharray: 0;
  stroke-linejoin: miter;
  stroke-width: 8px;
}

@keyframes yippee {
  0% {
    transform: scale(1);
    fill: var(--fill);
    fill-opacity: 0;
    stroke-opacity: 1;
    stroke: var(--stroke);
    stroke-dasharray: 10;
    stroke-width: 1px;
    stroke-linejoin: bevel;
  }

  30% {
    transform: scale(0);
    fill: var(--fill);
    fill-opacity: 0;
    stroke-opacity: 1;
    stroke: var(--stroke);
    stroke-dasharray: 10;
    stroke-width: 1px;
    stroke-linejoin: bevel;
  }

  30.1% {
    stroke: var(--fill);
    stroke-dasharray: 0;
    stroke-linejoin: miter;
    stroke-width: 8px;
  }

  60% {
    transform: scale(1.2);
    fill: var(--fill);
  }
}
/* –†–µ–π—Ç–∏–Ω–≥ */

.theme-text {
  color: #000;
  transition: color 0.3s ease;
  white-space: pre-wrap;
  text-decoration: none;
}

html.dark-theme .theme-text {
  color: #d0d0d0;
}

.username-display {
  position: absolute;
  top: 10px;
  right: 20px;
  font-weight: bold;
  font-size: 16px;
  color: #333;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
}

.username-display a {
  color: #000;
  text-decoration: none;
}

html.dark-theme .username-display a {
  color: white;
}

body, html {
  overflow-x: hidden;
  width: 100%;
  height: 100%;
  margin: 0;
  background: linear-gradient(135deg, #ACB6E5);
  color: #000;
  font-family: Arial, sans-serif;
  transition: background-color 0.3s, color 0.3s;
}

html.dark-theme {
  background-color: #000;
  color: #fff;
}

html.dark-theme body, html {
  background: linear-gradient(135deg, #243B55);
  color: #fff;
}

.background {
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
  padding: 40px;
  min-height: 100vh;
  width: 100%;
}

html.dark-theme .container {
  background-color: #121212;
  color: #fff;
}

button {
  width: 100%;
  padding: 10px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s ease;
}

button:hover {
  background-color: #00f2fe;
}

html.dark-theme button {
  width: 100%;
  padding: 10px;
  background-color: #5b7ea4;
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s ease;
}

html.dark-theme button:hover {
  background-color: #7bace0;
}

.button-disabled {
  width: 100%;
  padding: 10px;
  background-color: #6ab2ff;
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: not-allowed;
  opacity: 1;
}


.button-disabled:hover {
  background-color: #6ab2ff;
}

html.dark-theme .button-disabled {
  width: 100%;
  padding: 10px;
  background-color: #5b7ea4;
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: not-allowed;
  opacity: 1;
}

html.dark-theme .button-disabled:hover {
  background-color: #5b7ea4;
}

.button-disabled2 {
  width: 100%;
  padding: 10px;
  background-color: #ff0000;
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: not-allowed;
  opacity: 1;
}

.button-disabled2:hover {
  background-color: #ff0000;
}

html.dark-theme .button-disabled2 {
  width: 100%;
  padding: 10px;
  background-color: #810000;
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: not-allowed;
  opacity: 1;
}

html.dark-theme .button-disabled2:hover {
  background-color: #810000;
}

.styled-button {
  position: fixed;
  left: 10px;
  bottom: 10px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(90deg, #00caf3, #66b2ed);
  color: #5f2eea;
  font-family: Arial, sans-serif;
  font-size: 16px;
  font-weight: bold;
  padding: 10px 20px;
  border: none;
  border-radius: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  cursor: pointer;
  text-decoration: none;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.styled-button:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
}

.styled-button span {
  color: #8b5cf6;
  text-decoration: underline;
}

/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
.switch-wrapper {
    margin-top: 6px;
}

.switch {
    font-size: 17px;
    display: inline-block;
    width: 3.5em;
    height: 2em;
    position: relative;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    --background: #28096b;
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--background);
    transition: 0.5s;
    border-radius: 30px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 1.4em;
    width: 1.4em;
    border-radius: 50%;
    left: 10%;
    bottom: 15%;
    box-shadow: inset 8px -4px 0px 0px #fff000;
    background: var(--background);
    transition: 0.5s;
}

input:checked + .slider {
    background-color: #522ba7;
}

input:checked + .slider:before {
    transform: translateX(100%);
    box-shadow: inset 15px -4px 0px 15px #fff000;
}

</style>

<div class="username-display">
  {% if user.username %}
    <div id="menu" class="styled-button" onclick="redirectToMenu()">
      üî•
      <span style="color: #6a5acd; text-decoration: none; font-weight: bold;">–ú–µ–Ω—é</span>
      üî•
    </div>
  {% else %}
    <div id="menu" class="styled-button" onclick="redirectToMenuNone()">
      üî•
      <span style="color: #6a5acd; text-decoration: none; font-weight: bold;">–ú–µ–Ω—é</span>
      üî•
    </div>
  {% endif %}
</div>

<script>
  function redirectToMenu() {
    window.location.href = "/menu/{{ user.id }}";
  }
  function redirectToMenuNone() {
    window.location.href = "/menu/none";
  }
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("themeToggle");
  const html = document.documentElement;

  if (localStorage.getItem("darkTheme") === "true") {
    html.classList.add("dark-theme");
    toggle.checked = true;
  }

  toggle.addEventListener("change", function () {
    html.classList.toggle("dark-theme", this.checked);
    localStorage.setItem("darkTheme", this.checked);
  });
});
</script>
{% endblock %}
